---
interface Props {
  images: string[];
  title?: string;
}

const { images, title } = Astro.props;
---

{images && images.length > 0 && (
  <div class="my-8 image-gallery">
    {/* Main Image Viewer */}
    <div class="relative bg-muted rounded-lg overflow-hidden mb-4" style="height: 500px; max-height: 60vh;">
      <div class="gallery-main-container relative w-full h-full">
        {images.map((image, index) => (
          <div 
            class={`gallery-slide absolute inset-0 transition-opacity duration-500 ${index === 0 ? 'opacity-100 z-10' : 'opacity-0 z-0'}`}
            data-slide-index={index}
          >
            <img
              src={image}
              alt={`${title || 'Gallery'} ${index + 1}`}
              class="w-full h-full object-contain"
              loading={index === 0 ? 'eager' : 'lazy'}
            />
          </div>
        ))}
      </div>

      {/* Counter */}
      <div class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-black/60 text-white px-4 py-2 rounded-full text-sm font-medium z-20">
        <span class="current-slide">1</span> / <span class="total-slides">{images.length}</span>
      </div>

      {/* Navigation Arrows */}
      {images.length > 1 && (
        <>
          <button 
            class="gallery-prev absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/90 hover:bg-white p-3 rounded-full shadow-lg transition-all z-20 backdrop-blur-sm"
            aria-label="Previous image"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m15 18-6-6 6-6"></path>
            </svg>
          </button>
          <button 
            class="gallery-next absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/90 hover:bg-white p-3 rounded-full shadow-lg transition-all z-20 backdrop-blur-sm"
            aria-label="Next image"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m9 18 6-6-6-6"></path>
            </svg>
          </button>
        </>
      )}

      {/* Action Buttons (Top Right) */}
      <div class="absolute top-4 right-4 flex gap-2 z-20">
        <button 
          class="gallery-slideshow bg-white/90 hover:bg-white p-2 rounded-full shadow-lg transition-all backdrop-blur-sm"
          aria-label="Slideshow"
          title="Slideshow"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
        </button>
        <button 
          class="gallery-share bg-white/90 hover:bg-white p-2 rounded-full shadow-lg backdrop-blur-sm share-button-transition"
          aria-label="Share"
          title="Share"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
            <polyline points="16 6 12 2 8 6"></polyline>
            <line x1="12" y1="2" x2="12" y2="15"></line>
          </svg>
        </button>
        <button 
          class="gallery-fullscreen bg-white/90 hover:bg-white p-2 rounded-full shadow-lg transition-all backdrop-blur-sm"
          aria-label="Fullscreen"
          title="Fullscreen"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 3H5a2 2 0 0 0-2 2v3"></path>
            <path d="M21 8V5a2 2 0 0 0-2-2h-3"></path>
            <path d="M3 16v3a2 2 0 0 0 2 2h3"></path>
            <path d="M16 21h3a2 2 0 0 0 2-2v-3"></path>
          </svg>
        </button>
      </div>
    </div>

    {/* Slideshow Controls Panel */}
    <div class="slideshow-panel hidden bg-card border border-border rounded-lg p-4 mb-4 shadow-lg">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-3">
          <button class="slideshow-play-pause bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/90 transition-colors flex items-center gap-2">
            <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            <svg class="pause-icon hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="6" y="4" width="4" height="16"></rect>
              <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
            <span class="slideshow-status">Play</span>
          </button>
        </div>
        
        <div class="flex items-center gap-4 flex-wrap">
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium">Speed:</label>
            <select class="slideshow-speed bg-background border border-border rounded px-2 py-1 text-sm">
              <option value="2000">Fast (2s)</option>
              <option value="3000" selected>Normal (3s)</option>
              <option value="5000">Slow (5s)</option>
            </select>
          </div>
          
          <div class="flex items-center gap-2">
            <input type="checkbox" id="slideshow-loop" class="slideshow-loop w-4 h-4" checked />
            <label for="slideshow-loop" class="text-sm font-medium cursor-pointer">Loop</label>
          </div>
        </div>
      </div>
    </div>

    {/* Thumbnail Strip */}
    {images.length > 1 && (
      <div class="relative max-w-full">
        <div class="thumbnail-container flex gap-2 overflow-x-auto pb-2 scroll-smooth px-1">
          {images.map((image, index) => (
            <button
              class={`thumbnail flex-shrink-0 w-20 h-14 rounded-lg overflow-hidden border-2 transition-all ${index === 0 ? 'border-primary ring-2 ring-primary/50' : 'border-transparent hover:border-secondary'}`}
              data-thumbnail-index={index}
            >
              <img
                src={image}
                alt={`Thumbnail ${index + 1}`}
                class="w-full h-full object-cover"
                loading="lazy"
              />
            </button>
          ))}
        </div>

        {/* Scroll Arrows for Thumbnails */}
        <button 
          class="thumbnail-scroll-left absolute left-0 top-1/2 transform -translate-y-1/2 bg-white/90 hover:bg-white p-1 rounded-full shadow-md transition-all hidden"
          aria-label="Scroll left"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m15 18-6-6 6-6"></path>
          </svg>
        </button>
        <button 
          class="thumbnail-scroll-right absolute right-0 top-1/2 transform -translate-y-1/2 bg-white/90 hover:bg-white p-1 rounded-full shadow-md transition-all hidden"
          aria-label="Scroll right"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m9 18 6-6-6-6"></path>
          </svg>
        </button>
      </div>
    )}
  </div>
)}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const gallery = document.querySelector('.image-gallery');
    if (!gallery) return;

    const slides = gallery.querySelectorAll('.gallery-slide');
    const thumbnails = gallery.querySelectorAll('.thumbnail');
    const prevBtn = gallery.querySelector('.gallery-prev');
    const nextBtn = gallery.querySelector('.gallery-next');
    const currentSlideEl = gallery.querySelector('.current-slide');
    const thumbnailContainer = gallery.querySelector('.thumbnail-container');
    const slideshowBtn = gallery.querySelector('.gallery-slideshow');
    const shareBtn = gallery.querySelector('.gallery-share');
    const slideshowPanel = gallery.querySelector('.slideshow-panel');
    const playPauseBtn = gallery.querySelector('.slideshow-play-pause');
    const slideshowStatus = gallery.querySelector('.slideshow-status');
    const playIcon = gallery.querySelector('.play-icon');
    const pauseIcon = gallery.querySelector('.pause-icon');
    const speedSelect = gallery.querySelector('.slideshow-speed') as HTMLSelectElement;
    const loopCheckbox = gallery.querySelector('.slideshow-loop') as HTMLInputElement;
    
    let currentIndex = 0;
    let slideshowInterval: number | null = null;
    let isPlaying = false;

    function updateSlide(index: number) {
      // Update slides
      slides.forEach((slide, i) => {
        if (i === index) {
          slide.classList.remove('opacity-0', 'z-0');
          slide.classList.add('opacity-100', 'z-10');
        } else {
          slide.classList.remove('opacity-100', 'z-10');
          slide.classList.add('opacity-0', 'z-0');
        }
      });

      // Update thumbnails
      thumbnails.forEach((thumb, i) => {
        if (i === index) {
          thumb.classList.add('border-primary', 'ring-2', 'ring-primary/50');
          thumb.classList.remove('border-transparent');
        } else {
          thumb.classList.remove('border-primary', 'ring-2', 'ring-primary/50');
          thumb.classList.add('border-transparent');
        }
      });

      // Update counter
      if (currentSlideEl) {
        currentSlideEl.textContent = String(index + 1);
      }

      // Scroll thumbnail into view
      if (thumbnails[index] && thumbnailContainer) {
        thumbnails[index].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }

      currentIndex = index;
    }

    function nextSlide() {
      if (currentIndex < slides.length - 1) {
        updateSlide(currentIndex + 1);
        return true;
      } else if (loopCheckbox?.checked) {
        updateSlide(0);
        return true;
      }
      return false;
    }

    function startSlideshow() {
      if (slideshowInterval) return;
      
      isPlaying = true;
      playIcon?.classList.add('hidden');
      pauseIcon?.classList.remove('hidden');
      if (slideshowStatus) slideshowStatus.textContent = 'Pause';
      
      const speed = parseInt(speedSelect?.value || '3000');
      slideshowInterval = window.setInterval(() => {
        const hasNext = nextSlide();
        if (!hasNext && !loopCheckbox?.checked) {
          stopSlideshow();
        }
      }, speed);
    }

    function stopSlideshow() {
      if (slideshowInterval) {
        clearInterval(slideshowInterval);
        slideshowInterval = null;
      }
      
      isPlaying = false;
      playIcon?.classList.remove('hidden');
      pauseIcon?.classList.add('hidden');
      if (slideshowStatus) slideshowStatus.textContent = 'Play';
    }

    // Previous button
    prevBtn?.addEventListener('click', () => {
      stopSlideshow();
      const newIndex = currentIndex > 0 ? currentIndex - 1 : slides.length - 1;
      updateSlide(newIndex);
    });

    // Next button
    nextBtn?.addEventListener('click', () => {
      stopSlideshow();
      const newIndex = currentIndex < slides.length - 1 ? currentIndex + 1 : 0;
      updateSlide(newIndex);
    });

    // Thumbnail clicks
    thumbnails.forEach((thumb, index) => {
      thumb.addEventListener('click', () => {
        stopSlideshow();
        updateSlide(index);
      });
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        prevBtn?.click();
      } else if (e.key === 'ArrowRight') {
        nextBtn?.click();
      } else if (e.key === 'Escape' && isPlaying) {
        stopSlideshow();
      }
    });

    // Slideshow button
    slideshowBtn?.addEventListener('click', () => {
      slideshowPanel?.classList.toggle('hidden');
    });

    // Play/Pause button
    playPauseBtn?.addEventListener('click', () => {
      if (isPlaying) {
        stopSlideshow();
      } else {
        startSlideshow();
      }
    });

    // Speed change
    speedSelect?.addEventListener('change', () => {
      if (isPlaying) {
        stopSlideshow();
        startSlideshow();
      }
    });

    // Share button
    shareBtn?.addEventListener('click', async () => {
      const currentImage = slides[currentIndex]?.querySelector('img')?.src;
      if (!currentImage) return;

      // Create checkmark icon temporarily
      const originalIcon = shareBtn.innerHTML;
      const checkmarkIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      `;

      if (navigator.share) {
        try {
          await navigator.share({
            title: document.title,
            url: window.location.href,
          });
          // Show checkmark on successful share
          shareBtn.innerHTML = checkmarkIcon;
          shareBtn.classList.add('bg-green-100');
          setTimeout(() => {
            shareBtn.innerHTML = originalIcon;
            shareBtn.classList.remove('bg-green-100');
          }, 3000);
        } catch (err) {
          console.log('Share cancelled or failed');
        }
      } else {
        // Fallback: copy URL to clipboard
        try {
          await navigator.clipboard.writeText(window.location.href);
          // Show checkmark
          shareBtn.innerHTML = checkmarkIcon;
          shareBtn.classList.add('bg-green-100');
          // Fade out after 3 seconds
          setTimeout(() => {
            shareBtn.innerHTML = originalIcon;
            shareBtn.classList.remove('bg-green-100');
          }, 3000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      }
    });

    // Fullscreen button
    const fullscreenBtn = gallery.querySelector('.gallery-fullscreen');
    fullscreenBtn?.addEventListener('click', () => {
      const mainContainer = gallery.querySelector('.gallery-main-container')?.parentElement;
      if (mainContainer) {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          mainContainer.requestFullscreen();
        }
      }
    });
  });
</script>

<style>
  .image-gallery {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
  }

  .thumbnail-container {
    scrollbar-width: thin;
    scrollbar-color: hsl(var(--secondary) / 0.5) transparent;
    max-width: 100%;
  }

  .thumbnail-container::-webkit-scrollbar {
    height: 6px;
  }

  .thumbnail-container::-webkit-scrollbar-track {
    background: transparent;
  }

  .thumbnail-container::-webkit-scrollbar-thumb {
    background-color: hsl(var(--secondary) / 0.5);
    border-radius: 3px;
  }

  .thumbnail-container::-webkit-scrollbar-thumb:hover {
    background-color: hsl(var(--secondary) / 0.7);
  }

  .share-button-transition {
    transition: all 0.3s ease-in-out;
  }

  .gallery-share.bg-green-100 {
    background-color: rgb(220 252 231) !important;
  }

  @media (max-width: 768px) {
    .image-gallery .relative.bg-muted {
      height: 300px !important;
      max-height: 50vh !important;
    }
    
    .thumbnail {
      width: 60px !important;
      height: 45px !important;
    }
  }

  @media (min-width: 769px) and (max-width: 1024px) {
    .image-gallery .relative.bg-muted {
      height: 400px !important;
      max-height: 55vh !important;
    }
  }
</style>
