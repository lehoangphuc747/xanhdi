---
import LayoutTinTuc from '../../layouts/LayoutTinTuc.astro';
import ImageGallery from '../../components/ImageGallery.astro';
import RelatedTinTuc from '../../components/TinTuc/RelatedTinTuc.astro';
import NavigationTinTuc from '../../components/TinTuc/NavigationTinTuc.astro';
import { getCollection } from 'astro:content';
import '../../styles/markdown.css';

// Generate static paths for all posts
export async function getStaticPaths() {
  const allPosts = await getCollection('tin-tuc');
  
  return allPosts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

// Get all posts for navigation and related posts
const allPosts = await getCollection('tin-tuc');

interface Props {
  post: (typeof allPosts)[0];
}

const { post } = Astro.props;

// Import and render the MDX content dynamically
const mdxModule = await import(`../../content/tin-tuc/${post.id}.mdx`);
const Content = mdxModule.default;

// Get previous and next posts (sorted by date)
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);
const currentIndex = sortedPosts.findIndex((p) => p.id === post.id);
const prevPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;

// Format date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('vi-VN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
};
---

<LayoutTinTuc title={post.data.title}>
  <div class="container mx-auto px-4 sm:px-6 py-8 max-w-4xl">
    <article>
      {/* Back Button */}
      <a
        href="/TinTuc"
        class="inline-flex items-center gap-2 text-secondary hover:text-primary transition-colors mb-8"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="m15 18-6-6 6-6"></path>
        </svg>
        <span>Quay láº¡i</span>
      </a>

      {/* Header */}
      <div class="mb-8 text-center">
        <h1 class="text-4xl sm:text-5xl font-bold text-primary mb-4">
          {post.data.title}
        </h1>

        {/* Meta Info */}
        <div class="flex flex-wrap items-center justify-center gap-4 text-sm text-muted-foreground border-b border-border/50 pb-4">
          <div class="flex items-center gap-2">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <time datetime={post.data.pubDate.toISOString()}>
              {formatDate(post.data.pubDate)}
            </time>
          </div>

          {post.data.author && (
            <div class="flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span>{post.data.author}</span>
            </div>
          )}

          {post.data.category && (
            <div class="flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              </svg>
              <span>{post.data.category}</span>
            </div>
          )}

          {post.data.tags && post.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {post.data.tags.map((tag) => (
                <span class="inline-block px-2 py-1 bg-primary/10 rounded-full text-xs font-medium text-primary">
                  {tag}
                </span>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Featured Image or Gallery */}
      {post.data.previewImages && post.data.previewImages.length > 0 ? (
        <ImageGallery images={post.data.previewImages} />
      ) : post.data.image ? (
        <div class="mb-8 rounded-lg overflow-hidden">
          <img
            src={post.data.image}
            alt={post.data.title}
            class="w-full h-96 object-cover"
          />
        </div>
      ) : null}

      {/* Description */}
      {post.data.description && (
        <p class="text-lg text-muted-foreground mb-8 italic text-center">
          {post.data.description}
        </p>
      )}

      {/* Content */}
      <div class="markdown-content mb-12">
        <Content />
      </div>

      {/* Navigation: Previous/Next */}
      <NavigationTinTuc 
        prevPost={prevPost ? { id: prevPost.id, title: prevPost.data.title } : null}
        nextPost={nextPost ? { id: nextPost.id, title: nextPost.data.title } : null}
      />
    </article>

    {/* Related News */}
    <RelatedTinTuc
      currentPostId={post.id}
      currentTags={post.data.tags || []}
      allPosts={allPosts}
    />
  </div>
</LayoutTinTuc>
